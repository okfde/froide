!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.redact=e():(t.Froide=t.Froide||{},t.Froide.components=t.Froide.components||{},t.Froide.components.redact=e())}(window,function(){return function(t){function e(e){for(var r,i,s=e[0],c=e[1],u=e[2],h=0,f=[];h<s.length;h++)i=s[h],o[i]&&f.push(o[i][0]),o[i]=0;for(r in c)Object.prototype.hasOwnProperty.call(c,r)&&(t[r]=c[r]);for(l&&l(e);f.length;)f.shift()();return a.push.apply(a,u||[]),n()}function n(){for(var t,e=0;e<a.length;e++){for(var n=a[e],r=!0,s=1;s<n.length;s++){var c=n[s];0!==o[c]&&(r=!1)}r&&(a.splice(e--,1),t=i(i.s=n[0]))}return t}var r={},o={6:0},a=[];function i(e){if(r[e])return r[e].exports;var n=r[e]={i:e,l:!1,exports:{}};return t[e].call(n.exports,n,n.exports,i),n.l=!0,n.exports}i.e=function(t){var e=[],n=o[t];if(0!==n)if(n)e.push(n[2]);else{var r=new Promise(function(e,r){n=o[t]=[e,r]});e.push(n[2]=r);var a,s=document.createElement("script");s.charset="utf-8",s.timeout=120,i.nc&&s.setAttribute("nonce",i.nc),s.src=function(t){return i.p+""+({9:"vendors~pdfjsWorker"}[t]||t)+".js"}(t);var c=new Error;a=function(e){s.onerror=s.onload=null,clearTimeout(u);var n=o[t];if(0!==n){if(n){var r=e&&("load"===e.type?"missing":e.type),a=e&&e.target&&e.target.src;c.message="Loading chunk "+t+" failed.\n("+r+": "+a+")",c.type=r,c.request=a,n[1](c)}o[t]=void 0}};var u=setTimeout(function(){a({type:"timeout",target:s})},12e4);s.onerror=s.onload=a,document.head.appendChild(s)}return Promise.all(e)},i.m=t,i.c=r,i.d=function(t,e,n){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(i.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)i.d(n,r,function(e){return t[e]}.bind(null,r));return n},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i.oe=function(t){throw console.error(t),t};var s=window.webpackJsonp=window.webpackJsonp||[],c=s.push.bind(s);s.push=e,s=s.slice();for(var u=0;u<s.length;u++)e(s[u]);var l=c;return a.push([71,0]),n()}({28:function(t,e,n){},41:function(t,e){},42:function(t,e){},43:function(t,e){},44:function(t,e){},46:function(t,e){var n=1/0,r=9007199254740991,o=1.7976931348623157e308,a=NaN,i="[object Function]",s="[object GeneratorFunction]",c="[object Symbol]",u=/^\s+|\s+$/g,l=/^[-+]0x[0-9a-f]+$/i,h=/^0b[01]+$/i,f=/^0o[0-7]+$/i,d=/^(?:0|[1-9]\d*)$/,g=parseInt,p=Object.prototype.toString,v=Math.ceil,m=Math.max;function b(t){var e=typeof t;return!!t&&("object"==e||"function"==e)}function y(t){return t?(t=function(t){if("number"==typeof t)return t;if(function(t){return"symbol"==typeof t||function(t){return!!t&&"object"==typeof t}(t)&&p.call(t)==c}(t))return a;if(b(t)){var e="function"==typeof t.valueOf?t.valueOf():t;t=b(e)?e+"":e}if("string"!=typeof t)return 0===t?t:+t;t=t.replace(u,"");var n=h.test(t);return n||f.test(t)?g(t.slice(2),n?2:8):l.test(t)?a:+t}(t))===n||t===-n?(t<0?-1:1)*o:t==t?t:0:0===t?t:0}var P=function(t){return function(e,n,o){return o&&"number"!=typeof o&&function(t,e,n){if(!b(n))return!1;var o=typeof e;return!!("number"==o?function(t){return null!=t&&function(t){return"number"==typeof t&&t>-1&&t%1==0&&t<=r}(t.length)&&!function(t){var e=b(t)?p.call(t):"";return e==i||e==s}(t)}(n)&&function(t,e){return!!(e=null==e?r:e)&&("number"==typeof t||d.test(t))&&t>-1&&t%1==0&&t<e}(e,n.length):"string"==o&&e in n)&&function(t,e){return t===e||t!=t&&e!=e}(n[e],t)}(e,n,o)&&(n=o=void 0),e=y(e),void 0===n?(n=e,e=0):n=y(n),function(t,e,n,r){for(var o=-1,a=m(v((e-t)/(n||1)),0),i=Array(a);a--;)i[r?a:++o]=t,t+=n;return i}(e,n,o=void 0===o?e<n?1:-1:y(o),t)}}();t.exports=P},5:function(t,e,n){"use strict";function r(t){return function(t){if(Array.isArray(t)){for(var e=0,n=new Array(t.length);e<t.length;e++)n[e]=t[e];return n}}(t)||function(t){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t))return Array.from(t)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function o(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function a(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}n.d(e,"a",function(){return i}),n.d(e,"e",function(){return s}),n.d(e,"d",function(){return c}),n.d(e,"c",function(){return u}),n.d(e,"b",function(){return l});var i=function(){function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.config=e}return function(t,e,n){e&&a(t.prototype,e),n&&a(t,n)}(t,[{key:"getJson",value:function(t){return new Promise(function(e,n){var r=new XMLHttpRequest;r.open("GET",t,!0),r.onload=function(){if(r.status>=400)try{return n(JSON.parse(r.responseText))}catch(t){return n(r.responseText)}e(JSON.parse(r.responseText))},r.onerror=function(){n(r.statusText)},r.send()})}},{key:"getObjects",value:function(t){return new Promise(function(e,n){t.then(function(t){return e(t.objects)}).catch(function(t){return n(t)})})}},{key:"getJsonObjects",value:function(t){var e=this;return new Promise(function(n,r){e.getJson(t).then(function(t){return n(t.objects)}).catch(function(t){return r(t)})})}},{key:"getPublicBody",value:function(t){var e=this.config.url.getPublicBody.replace(/\/0\//,"/".concat(t,"/"));return this.getJson(e)}},{key:"autocompletePublicBody",value:function(t){var e=encodeURIComponent(t),n=this.config.url.autocompletePublicBody+"?query="+e;return this.getJsonObjects(n)}},{key:"getUser",value:function(){return this.getJson(this.config.url.user)}},{key:"getJsonForUrl",value:function(t,e,n){var r=!1;return void 0!==e&&e&&(r=!0,t=t+"?q="+encodeURIComponent(e)),void 0!==n&&function(){var e=[],o=function(t){var r=n[t];null!==r&&(Array.isArray(r)||(r=[r]),r.forEach(function(n){e.push(t+"="+encodeURIComponent(n))}))};for(var a in n)o(a);t+=r?"&":"?",t+=e.join("&")}(),this.getJson(t)}},{key:"searchPublicBodies",value:function(t,e){return this.getJsonForUrl(this.config.url.searchPublicBody,t,e)}},{key:"listPublicBodies",value:function(t,e){return this.getJsonForUrl(this.config.url.listPublicBodies,t,e)}},{key:"getLawsForPublicBodies",value:function(t,e){e=e||{};var n={},r=[];return t.forEach(function(t){t.laws.forEach(function(t){if("string"==typeof t){if(void 0!==e[t])return;var o=t.split("/"),a=o[o.length-2];void 0===n[a]&&(n[a]=!0,r.push(a))}})}),0===r.length?Promise.resolve([]):this.getJsonForUrl(this.config.url.listLaws,null,{id:r.join(",")}).then(function(t){return t.objects})}},{key:"listJurisdictions",value:function(t,e){return this.getJsonForUrl(this.config.url.listJurisdictions,t,e)}},{key:"listCategories",value:function(t,e){return this.getJsonForUrl(this.config.url.listCategories,t,e)}},{key:"listClassifications",value:function(t,e){return this.getJsonForUrl(this.config.url.listClassifications,t,e)}},{key:"listGeoregions",value:function(t,e){return this.getJsonForUrl(this.config.url.listGeoregions,t,e)}},{key:"searchFoiRequests",value:function(t){var e=encodeURIComponent(t),n=this.config.url.searchRequests+"?q="+e;return this.getJsonObjects(n)}}]),t}();function s(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2?arguments[2]:void 0;return window.fetch(t,{method:"POST",cache:"no-cache",credentials:"same-origin",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest","X-CSRFToken":n},body:JSON.stringify(e)}).then(function(t){return t.json()})}function c(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return e=e||{},window.fetch(t,{method:"GET",cache:"no-cache",credentials:"same-origin",headers:function(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter(function(t){return Object.getOwnPropertyDescriptor(n,t).enumerable}))),r.forEach(function(e){o(t,e,n[e])})}return t}({Accept:"application/json","X-Requested-With":"XMLHttpRequest"},e)}).then(function(t){return t.json()})}function u(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;return new Promise(function(a,i){c(t,e).then(function(t){n=Array.isArray(t.objects)?[].concat(r(n),r(t.objects)):[].concat(r(n),r(t.objects.results)),t.meta.next?(o&&o(n),u(t.meta.next,e,n).then(a).catch(i)):a(n)})})}function l(t){return window.fetch(t,{method:"GET",cache:"no-cache",credentials:"same-origin",headers:{pragma:"no-cache","cache-control":"no-cache"}})}},7:function(t,e,n){"use strict";function r(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function o(t){return t.replace(/(-\w)/g,function(t){return t[1].toUpperCase()})}function a(t,e){return function(){return e(t.tag,{domProps:{innerHTML:t.innerHTML}})}}function i(t,e){"string"==typeof t&&(t=document.querySelector(t));var n=function(t){for(var e=t.attributes,n={},r=0;r<e.length;r+=1){var a=e[r];if(("v"!==a.name[0]||"-"!==a.name[1])&&"id"!==a.name&&"class"!==a.name){var i=a.value,s=a.name;":"===a.name[0]&&(s=a.name.substring(1),"{"!==a.value[0]&&"["!==a.value[0]||(i=JSON.parse(a.value)),"true"===a.value&&(i=!0)),n[o(s)]=i}}return n}(t),i=function(t){for(var e=t.querySelectorAll("[slot]"),n={},r=0;r<e.length;r+=1){var o=e[r];n[o.attributes.slot.value]={tag:o.tagName.toLowerCase(),innerHTML:o.innerHTML}}return n}(t),s=function(t){var e={};if(t.id&&(e.attrs={id:t.id}),t.className){var n=t.className.split(" ");e.class={},n.forEach(function(t){e.class[t.trim()]=!0})}return e}(t);return function(t){var o=function(t,e){var n={};for(var r in t)n[r]=a(t[r],e);return n}(i,t);return t(e,function(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{},o=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(o=o.concat(Object.getOwnPropertySymbols(n).filter(function(t){return Object.getOwnPropertyDescriptor(n,t).enumerable}))),o.forEach(function(e){r(t,e,n[e])})}return t}({props:n,scopedSlots:o},s))}}n.d(e,"a",function(){return i})},71:function(t,e,n){t.exports=n(94)},78:function(t,e,n){"use strict";var r=n(28);n.n(r).a},94:function(t,e,n){"use strict";n.r(e);var r=n(1),o=n(7),a=(n(40),n(46)),i=n.n(a),s=n(12),c=n.n(s),u=n(5);function l(t){return function(t){if(Array.isArray(t)){for(var e=0,n=new Array(t.length);e<t.length;e++)n[e]=t[e];return n}}(t)||function(t){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t))return Array.from(t)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function h(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var n=[],r=!0,o=!1,a=void 0;try{for(var i,s=t[Symbol.iterator]();!(r=(i=s.next()).done)&&(n.push(i.value),!e||n.length!==e);r=!0);}catch(t){o=!0,a=t}finally{try{r||null==s.return||s.return()}finally{if(o)throw a}}return n}(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}var f={name:"redaction",props:["config","pdfPath","attachmentUrl","redactRegex","canPublish"],data:function(){return{doc:null,currentPage:null,page:null,numPages:null,containerId:"container-"+String(Math.random()).substr(2),canvasId:"canvas-"+String(Math.random()).substr(2),redactCanvasId:"redactCanvas-"+String(Math.random()).substr(2),textLayerId:"textlayer-"+String(Math.random()).substr(2),workingState:"loading",ready:!1,textOnly:!1,textDisabled:!0,pageScaleFactor:{},actionsPerPage:{},actionIndexPerPage:{},rectanglesPerPage:{},maxWidth:null,startDrag:null,endDrag:null,initialAutoRedact:{},errors:null,message:null,progressCurrent:null,progressTotal:null,hasTouch:"ontouchstart"in window,doubleTap:!1}},created:function(){var t=this;c.a.GlobalWorkerOptions.workerSrc=this.config.resources.pdfjsWorker,console.log(this.config.resources.pdfjsWorker,c.a),this.loadDocument().then(function(){return t.loadPage(1)})},computed:{i18n:function(){return this.config.i18n},hasNext:function(){return this.currentPage<this.numPages},hasPrevious:function(){return this.currentPage>1},canUndo:function(){return this.actionIndexPerPage[this.currentPage]>0},canRedo:function(){var t=this.actionsPerPage[this.currentPage];return void 0!==t&&this.actionIndexPerPage[this.currentPage]<t.length},pageOfTotal:function(){return null!==this.numPages?this.i18n.pageCurrentOfTotal.replace(/\$current/,this.currentPage).replace(/\$total/,this.numPages):""},regexList:function(){return this.redactRegex.map(function(t){return t=t.replace(/ /g,"\\s+"),t="\\b".concat(t,"\\b"),new RegExp(t,"g")})},container:function(){return this.$refs.container},canvas:function(){return document.getElementById(this.canvasId)},redactCanvas:function(){return document.getElementById(this.redactCanvasId)},textLayer:function(){return document.getElementById(this.textLayerId)},working:function(){return null!==this.workingState},loading:function(){return"loading"===this.workingState},redacting:function(){return"redacting"===this.workingState},sending:function(){return"sending"===this.workingState},progressUnknown:function(){return null===this.progressCurrent||void 0===this.progressTotal},progressPercent:function(){return this.progressUnknown?100:this.progressCurrent/this.progressTotal*100},progressWidth:function(){return"width: ".concat(this.progressPercent,"%")},csrfToken:function(){return document.querySelector("[name=csrfmiddlewaretoken]").value}},methods:{loadDocument:function(){var t=this,e=c.a.getDocument({url:this.pdfPath,isEvalSupported:!1,httpHeaders:{pragma:"no-cache","cache-control":"no-cache"}});return e.onProgress=function(e){t.progressCurrent=e.loaded,t.progressTotal=e.total},e.promise.then(function(e){t.workingState=null,t.ready=!0,t.doc=e,t.numPages=t.doc.numPages;for(var n=1;n<=t.numPages;n+=1)r.a.set(t.actionsPerPage,n,[]),r.a.set(t.actionIndexPerPage,n,0);t.currentPage=1})},loadPage:function(t){var e=this;return this.doc.getPage(t).then(function(n){if(console.log("# Page "+t),e.page=n,null===e.maxWidth&&(e.maxWidth=e.$refs.containerWrapper.offsetWidth),void 0===e.pageScaleFactor[t]){var r=96/72,o=n.getViewport(96/72);o.width>e.maxWidth&&(r=e.maxWidth/o.width),e.pageScaleFactor[t]=r}var a=e.pageScaleFactor[t],i=n.getViewport(a);e.viewport=i,console.log(a,"Size: "+i.width+"x"+i.height,"at maxwidth",e.maxWidth);var s=e.canvas;s.width=i.width,s.height=i.height,e.redactCanvas.width=i.width,e.redactCanvas.height=i.height,e.container.style.width=Math.floor(i.width)+"px",e.container.style.height=Math.floor(i.height)+"px",e.textLayer.style.width=Math.floor(i.width)+"px",e.textLayer.style.height=Math.floor(i.height)+"px";var u=s.getContext("2d"),l=n.render({canvasContext:u,viewport:i}),h=n.getTextContent().then(function(t){for(;e.textLayer.firstChild;)e.textLayer.removeChild(e.textLayer.firstChild);return c.a.renderTextLayer({textContent:t,container:e.textLayer,viewport:i,enhanceTextSelection:!0}).promise});return Promise.all([l.promise,h]).then(e.textAvailable)})},goNext:function(){this.hasNext&&this.setCurrentPage(this.currentPage+1)},goPrevious:function(){this.hasPrevious&&this.setCurrentPage(this.currentPage-1)},setCurrentPage:function(t){return this.currentPage=t,this.loadPage(t)},toggleText:function(){this.textOnly=!this.textOnly,this.textDisabled=!this.textOnly},toggleDrawing:function(){this.textDisabled=!this.textDisabled,this.textOnly=!this.textDisabled},redact:function(){var t=this;this.$refs.top.scrollIntoView({behavior:"smooth",block:"start"}),this.ready=!1,this.workingState="sending",this.progressCurrent=0,this.progressTotal=this.numPages+1;var e=[];return i()(1,this.numPages+1).reduce(function(n,r){return n.then(function(){return t.setCurrentPage(r).then(function(){t.progressCurrent=r,e.push(t.serializePage(r))})})},Promise.resolve()).then(function(){return console.log(e),t.progressCurrent=null,t.sendSerializedPages(e).then(function(e){e?(t.progressCurrent=100,t.progressTotal=100,Object(u.b)(e.file_url).then(function(){document.location.href=e.anchor_url})):(t.workingState=null,t.errors=res||i18n.redactionTimeout,t.$refs.top.scrollIntoView(!0))}).catch(function(e){t.workingState=null,console.error(e),t.ready=!1,t.errors=e,t.$refs.top.scrollIntoView(!0)})})},sendSerializedPages:function(t){var e=this;return this.workingState="sending",this.progressCurrent=5,this.progressTotal=100,new Promise(function(n,r){var o=new window.XMLHttpRequest;o.open("POST",document.location.href),o.setRequestHeader("Content-Type","application/json"),o.setRequestHeader("X-CSRFToken",e.csrfToken),(o.upload?o.upload:o).addEventListener("progress",function(t){t.lengthComputable?(e.progressCurrent=t.loaded,e.progressTotal=t.total):e.progressCurrent=null}),o.onreadystatechange=function(){if(4===o.readyState)if(200===o.status)try{return e.progressCurrent=null,e.workingState="redacting",void e.waitOnAttachment(JSON.parse(o.responseText)).then(n).catch(r)}catch(t){return console.error("Failed to decode JSON",t,o.responseText),void r(e.i18n.redactionError)}else console.error("Non 200 response code",o.status),r(e.i18n.redactionError)},o.send(JSON.stringify(t))})},waitOnAttachment:function(t){var e=this;return new Promise(function(n,r){var o=t.resource_uri,a=0;window.setTimeout(function t(){Object(u.d)(o).then(function(o){if(o.pending||!o.approved)return(a+=5)>180?(console.error("Timeout while waiting for redaction"),r(e.i18n.redactionTimeout)):void(null===e.errors&&window.setTimeout(t,5e3));console.error("Attachment redacted."),n(o)}).catch(function(){return console.err("Could not get attachment via API"),r(e.i18n.redactionError)})},1e3)})},serializePage:function(t){var e=this,n=this.textLayer.children,r=Array.prototype.map.call(n,function(t){var n=h(e.getDivPos(t),2);return{pos:[n[0],n[1],t.offsetWidth,t.offsetHeight],fontFamily:t.style.fontFamily,fontSize:t.style.fontSize,transform:t.style.transform,text:t.textContent}});return{width:this.viewport.width,height:this.viewport.height,scaleFactor:this.scaleFactor,pageNumber:t,rects:this.rectanglesPerPage[t],texts:r}},getOffset:function(t){var e=(t.target||t.srcElement).getBoundingClientRect(),n=t.clientX,r=t.clientY;return t.touches&&t.touches.length>0?(n=t.touches[0].clientX,r=t.touches[0].clientY):t.changedTouches&&t.changedTouches.length>0&&(n=t.changedTouches[0].clientX,r=t.changedTouches[0].clientY),[n-e.left,r-e.top]},touchStart:function(t){var e=this;if(!this.doubleTap)return this.doubleTap=!0,setTimeout(function(){e.doubleTap=!1},500),!1;t.preventDefault(),this.mouseDown(t,!0)},touchEnd:function(t){this.mouseUp(t,!0)},touchMove:function(t){this.mouseMove(t,!0)},touchCancel:function(t){this.startDrag=null},mouseMove:function(t,e){this.hasTouch&&!e||null!==this.startDrag&&window.getSelection().isCollapsed&&(this.endDrag=this.getOffset(t),this.drawRectangles())},mouseDown:function(t,e){this.hasTouch&&!e||(this.startDrag=this.getOffset(t))},mouseUp:function(t,e){var n=this;if(!this.hasTouch||e){var r=window.getSelection();if(void 0!==r&&!r.isCollapsed)return console.log(r),this.startDrag=null,this.handleSelection(r),void r.removeAllRanges();if(null!==this.startDrag){var o=this.getOffset(t);if(Math.abs(o[0]-this.startDrag[0])<3&&Math.abs(o[1]-this.startDrag[1])<3)return console.log("Cancel empty select"),void(this.startDrag=null);var a=h(this.getRect(this.startDrag,o),4),i=a[0],s=a[1],c=a[2],u=a[3],l=this.textLayer.children,f=Array.prototype.filter.call(l,function(t){var e=h(n.getDivPos(t),2),r=e[0],o=e[1],a=t.offsetWidth,l=t.offsetHeight;return i<r+a&&i+c>r&&s<o+l&&s+u>o}).map(function(t){return n.redactText(t,0,t.textContent).texts[0]});this.addAction({type:"redact",rects:[[i,s,c,u]],page:this.currentPage,texts:f}),this.startDrag=null}}},getRect:function(t,e){var n,r,o,a;return t[0]<e[0]?(n=t[0],o=e[0]-n):(n=e[0],o=t[0]-n),t[1]<e[1]?(r=t[1],a=e[1]-r):(r=e[1],a=t[1]-r),[n,r,o,a]},handleSelection:function(t){var e=this;function n(t){if(t.firstChild)return t.firstChild;for(;t;){if(t.nextSibling)return t.nextSibling;t=t.parentNode}}for(var r=[],o=function(){var o=t.getRangeAt(a);if(o.isCollapsed)return"continue";if(o.startContainer===o.endContainer){var i=o.startContainer;"#text"===i.nodeName&&(i=i.parentNode);var s=e.redactRange(i,o.startOffset,o.endOffset);return r.push(s),"continue"}(function(t){var e,r=t.startContainer,o=t.endContainer,a=t.commonAncestorContainer,i=[];for(e=r.parentNode;e&&(i.push(e),e!==a);e=e.parentNode);for(i.reverse(),e=r;e&&(i.push(e),e!==o);e=n(e));return i})(o).forEach(function(t){var n=0,a=0;if(null!==t.textContent&&(a=t.textContent.length),t===o.startContainer?n=o.startOffset:t===o.endContainer&&(a=t.endOffset),"#text"===t.nodeName&&(t=t.parentNode),console.log(t,n,a),null!==t&&void 0!==t.dataset&&void 0!==t.dataset.index){var i=e.redactRange(t,n,a);r.push(i)}})},a=0;a<t.rangeCount;a+=1)o();var i=this.combineActions(r);this.addAction(i)},combineActions:function(t){return{type:"redact",texts:t.reduce(function(t,e){return t.concat(e.texts)},[]),rects:t.reduce(function(t,e){return t.concat(e.rects)},[]),page:this.currentPage}},textAvailable:function(){var t=this,e=0;Array.prototype.forEach.call(this.textLayer.children,function(t){t.dataset.index=e,e+=1}),void 0===this.initialAutoRedact[this.currentPage]&&(this.regexList.forEach(function(e){return t.autoRedact(e)}),r.a.set(this.initialAutoRedact,this.currentPage,!0)),this.applyActionsOnPageLoad()},drawRectangle:function(t,e){var n=h(e,4),r=n[0],o=n[1],a=n[2],i=n[3];t.fillStyle="#000",t.fillRect(r,o,a,i)},drawRectangles:function(){var t=this,e=this.redactCanvas.getContext("2d");e.clearRect(0,0,this.canvas.width,this.canvas.height),void 0!==this.rectanglesPerPage[this.currentPage]&&this.rectanglesPerPage[this.currentPage].forEach(function(n){t.drawRectangle(e,n)}),this.startDrag&&this.endDrag&&this.drawRectangle(e,this.getRect(this.startDrag,this.endDrag))},applyActionsOnPageLoad:function(){var t=this;void 0===this.rectanglesPerPage[this.currentPage]&&r.a.set(this.rectanglesPerPage,this.currentPage,[]),this.actionsPerPage[this.currentPage].forEach(function(e){t.applyAction(e,!0)}),this.drawRectangles()},undo:function(){if(this.canUndo){var t=this.actionIndexPerPage[this.currentPage];t-=1,r.a.set(this.actionIndexPerPage,this.currentPage,t);var e=this.actionsPerPage[this.currentPage][t];this.unapplyAction(e)}},redo:function(){if(this.canRedo){var t=this.actionIndexPerPage[this.currentPage],e=this.actionsPerPage[this.currentPage][t];t+=1,r.a.set(this.actionIndexPerPage,this.currentPage,t),this.applyAction(e)}},addAction:function(t){var e=this.actionsPerPage[t.page].slice();(e=e.slice(0,this.actionIndexPerPage[t.page])).push(t),r.a.set(this.actionsPerPage,t.page,e),r.a.set(this.actionIndexPerPage,t.page,this.actionsPerPage[t.page].length),this.applyAction(t)},applyAction:function(t){var e=this,n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];void 0===this.rectanglesPerPage[t.page]&&r.a.set(this.rectanglesPerPage,t.page,[]),void 0===t.rects||n||(r.a.set(this.rectanglesPerPage,t.page,[].concat(l(this.rectanglesPerPage[t.page]),l(t.rects))),this.drawRectangles()),void 0!==t.texts&&t.texts.length>0&&t.texts.forEach(function(t){var n=e.textLayer.querySelector('[data-index="'.concat(t.textIndex,'"]'));null!==n&&(n.textContent=t.textAfter)})},unapplyAction:function(t){var e=this;if(void 0!==t.rects&&t.rects.length>0){var n=this.rectanglesPerPage[t.page].filter(function(e){return 0===t.rects.filter(function(t){var n=h(t,4),r=n[0],o=n[1],a=n[2],i=n[3],s=h(e,4),c=s[0],u=s[1],l=s[2],f=s[3];return r===c&&o===u&&a===l&&i===f}).length});r.a.set(this.rectanglesPerPage,t.page,n),this.drawRectangles()}void 0!==t.texts&&t.texts.length>0&&t.texts.forEach(function(t){var n=e.textLayer.querySelector('[data-index="'.concat(t.textIndex,'"]'));null!==n&&(n.textContent=t.textBefore)})},autoRedact:function(t){var e=this,n=this.textLayer.children,r=Array.prototype.filter.call(n,function(e){return e.textContent.match(t)});r.forEach(function(n){for(var r,o=n.textContent;r=t.exec(o);){var a=r.index,i=r[0],s=e.redactText(n,a,i);e.addAction(s)}}),r.length>0&&(this.message=this.i18n.autoRedacted)},getDivPos:function(t){return[parseInt(t.style.left.replace("px","")),parseInt(t.style.top.replace("px",""))]},redactText:function(t,e,n){return this.redactRange(t,e,e+n.length)},redactRange:function(t,e,n){var r=["█","▉","▊","▋","▌","▍","▎","▏"],o=[1,7/8,.75,5/8,.5,3/8,.25,1/8],a=t.textContent,i=a.substr(e,n-e);t.textContent=r[0];var s=t.offsetWidth;t.textContent=i;for(var c="",u=t.offsetWidth,l=0;l<r.length&&u>0;){var f=s*o[l];if(f>u)l+=1;else{var d=Math.floor(u/f);c+=r[l].repeat(d),u=u%f/f,l+=1}}t.textContent=a.substr(0,e);var g=t.offsetWidth;t.textContent=a.substr(0,e+i.length);var p=t.offsetWidth;t.textContent=a;var v=h(this.getDivPos(t),2),m=v[0],b=v[1];m+=g;var y=p-g,P=Math.min(1.2*t.offsetHeight,t.offsetHeight+10);return{type:"redact",texts:[{textIndex:t.dataset.index,textBefore:a,textAfter:a.replace(i,c)}],rects:[[m-2,b,y+4,P]],page:this.currentPage}}}},d=(n(78),n(2)),g=Object(d.a)(f,function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("div",{ref:"top",staticClass:"pdf-redaction-tool",attrs:{id:"pdf-viewer"}},[t.message?n("div",{staticClass:"row"},[n("div",{staticClass:"col-lg-12"},[n("div",{staticClass:"alert alert-info",attrs:{role:"alert"}},[t._v(t._s(t.message))])])]):t._e(),t._v(" "),t.errors?n("div",{staticClass:"row"},[n("div",{staticClass:"col-lg-12"},[n("div",{staticClass:"alert alert-error",attrs:{role:"alert"}},[t._v(t._s(t.errors))])])]):t._e(),t._v(" "),t.working?n("div",{staticClass:"row mt-5"},[n("div",{staticClass:"col-lg-12"},[n("div",{staticClass:"text-center"},[t.loading?n("h3",[t._v("\n          "+t._s(t.i18n.loadingPdf)+"\n        ")]):t._e(),t._v(" "),t.redacting?n("h3",[t._v("\n          "+t._s(t.i18n.redacting)+"\n        ")]):t._e(),t._v(" "),t.sending?n("h3",[t._v("\n          "+t._s(t.i18n.sending)+"\n        ")]):t._e()]),t._v(" "),n("div",{staticClass:"progress"},[n("div",{staticClass:"progress-bar",class:{"progress-bar-striped progress-bar-animated":t.progressUnknown},style:t.progressWidth,attrs:{role:"progressbar","aria-valuenow":t.progressPercent,"aria-valuemin":"0","aria-valuemax":"100"}})]),t._v(" "),t._m(0)])]):t._e(),t._v(" "),n("div",{staticClass:"row toolbar"},[t.ready?n("div",{staticClass:"btn-toolbar col-lg-12"},[n("div",{staticClass:"btn-group mr-1"},[n("button",{staticClass:"btn btn-light",attrs:{disabled:!t.canUndo,title:t.i18n.undo},on:{click:t.undo}},[n("i",{staticClass:"fa fa-step-backward"})]),t._v(" "),n("button",{staticClass:"btn btn-light",attrs:{disabled:!t.canRedo,"data-toggle":"tooltip","data-placement":"top",title:t.i18n.redo},on:{click:t.redo}},[n("i",{staticClass:"fa fa-step-forward"})])]),t._v(" "),n("div",{staticClass:"btn-group mr-1"},[n("button",{staticClass:"btn",class:{"btn-outline-info":!t.textOnly,"btn-info":t.textOnly},attrs:{title:t.i18n.toggleText},on:{click:function(e){return e.stopPropagation(),t.toggleText(e)}}},[n("i",{staticClass:"fa fa-align-justify"})]),t._v(" "),n("button",{staticClass:"btn",class:{"btn-outline-info":!t.textDisabled,"btn-info":t.textDisabled},attrs:{title:t.i18n.disableText},on:{click:function(e){return e.stopPropagation(),t.toggleDrawing(e)}}},[n("i",{staticClass:"fa fa-image"})])]),t._v(" "),n("div",{staticClass:"btn-group mr-1"},[n("button",{staticClass:"pdf-prev btn btn-light",attrs:{disabled:!t.hasPrevious},on:{click:t.goPrevious}},[t._v("\n          «\n          "),n("span",{staticClass:"sr-only"},[t._v(t._s(t.i18n.previousPage))])]),t._v(" "),n("span",{staticClass:"input-group-text"},[t._v("\n          "+t._s(t.pageOfTotal)+"\n        ")]),t._v(" "),n("button",{staticClass:"pdf-next btn btn-light",attrs:{disabled:!t.hasNext},on:{click:t.goNext}},[n("span",{staticClass:"sr-only"},[t._v(t._s(t.i18n.nextPage))]),t._v("\n          »\n        ")])]),t._v(" "),n("div",{staticClass:"btn-group mr-lg-1 ml-auto mt-1 mt-lg-0"},[n("button",{staticClass:"btn btn-dark",on:{click:t.redact}},[n("i",{staticClass:"fa fa-paint-brush"}),t._v("\n          "+t._s(t.i18n.redactAndPublish)+"\n        ")])]),t._v(" "),n("div",{staticClass:"btn-group ml-auto mt-1 mt-lg-0"},[t.canPublish?n("form",{attrs:{method:"post",action:t.config.config.publishUrl}},[n("input",{attrs:{type:"hidden",name:"csrfmiddlewaretoken"},domProps:{value:t.csrfToken}}),t._v(" "),n("button",{staticClass:"btn btn-success",attrs:{type:"submit"}},[n("i",{staticClass:"fa fa-check"}),t._v("\n            "+t._s(t.i18n.publishWithoutRedaction)+"\n          ")])]):n("a",{staticClass:"btn btn-secondary",attrs:{href:t.attachmentUrl}},[t._v("\n          "+t._s(t.i18n.cancel)+"\n        ")])])]):t._e()]),t._v(" "),n("div",{staticClass:"row mt-3"},[n("div",{ref:"containerWrapper",staticClass:"col-lg-12 overflow-auto"},[n("div",{ref:"container",staticClass:"redactContainer",class:{"hide-redacting":t.working},attrs:{id:t.containerId}},[n("canvas",{directives:[{name:"show",rawName:"v-show",value:!t.textOnly,expression:"!textOnly"}],staticClass:"redactLayer",attrs:{id:t.canvasId}}),t._v(" "),n("canvas",{directives:[{name:"show",rawName:"v-show",value:!t.textOnly,expression:"!textOnly"}],staticClass:"redactLayer",attrs:{id:t.redactCanvasId},on:{mousedown:t.mouseDown,mousemove:t.mouseMove,mouseup:t.mouseUp,touchstart:t.touchStart,touchend:t.touchEnd,touchmove:t.touchMove,touchcancel:t.touchCancel}}),t._v(" "),n("div",{staticClass:"textLayer",class:{textActive:t.textOnly,textDisabled:t.textDisabled},attrs:{id:t.textLayerId},on:{mousedown:t.mouseDown,mousemove:t.mouseMove,mouseup:t.mouseUp,touchstart:t.touchStart,touchend:t.touchEnd,touchmove:t.touchMove,touchcancel:t.touchCancel}})])])]),t._v(" "),n("div",{staticClass:"row"},[t.ready?n("div",{staticClass:"btn-toolbar col-lg-12"},[n("div",{staticClass:"btn-group mr-auto ml-auto"},[n("button",{staticClass:"pdf-prev btn btn-light",attrs:{disabled:!t.hasPrevious},on:{click:t.goPrevious}},[t._v("\n          «\n          "+t._s(t.i18n.previousPage)+"\n        ")]),t._v(" "),n("span",{staticClass:"input-group-text"},[t._v("\n          "+t._s(t.pageOfTotal)+"\n        ")]),t._v(" "),n("button",{staticClass:"pdf-next btn btn-light",attrs:{disabled:!t.hasNext},on:{click:t.goNext}},[t._v("\n          "+t._s(t.i18n.nextPage)+"\n          »\n        ")])])]):t._e()])])},[function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"text-center mt-3"},[e("div",{staticClass:"spinner-border",attrs:{role:"status"}})])}],!1,null,null,null).exports;function p(t){new r.a({components:{Redaction:g},render:Object(o.a)(t,g)}).$mount(t)}r.a.config.productionTip=!1,document.addEventListener("DOMContentLoaded",function(){p("#redact")});var v={createRedaction:p};e.default=v}})});
//# sourceMappingURL=redact.js.map