{% extends 'foirequest/base.html' %}
{% load url from future %}
{% load i18n %}
{% load markup %}
{% load comments %}
{% load floppyforms %}
{% load foirequest_tags follower_tags account_tags %}

{% block title %}{{ object.title }}{% endblock %}

{% block metadescription %}{{ object.description }}{% endblock %}


{% block extra_head %}
<link rel="self" type="text/html" href="{% url 'foirequest-show' slug=object.slug %}"/>
<link rel="canonical" href="{% url 'foirequest-show' slug=object.slug %}"/>
<link href="{% url 'foirequest-feed' slug=object.slug %}" rel="alternate nofollow" type="application/rss+xml" title="{% blocktrans with title=object.title %}RSS Feed for request '{{ title }}'{% endblocktrans %}">
<link rel="alternate nofollow" type="application/atom+xml" title="{% blocktrans with title=object.title %}Atom feed for request '{{ title }}'{% endblocktrans %}" href="{% url 'foirequest-feed_atom' slug=object.slug %}" />
<link rel="stylesheet" href="{{ STATIC_URL }}css/print-request.css" type="text/css" media="print" />
{% endblock %}

{% block body %}

{% if not user.is_authenticated and object.awaits_classification %}
  {% url "account-login" as login_url %}
  <div class="alert alert-info no-print">{% blocktrans with login_url=login_url %}This request received a reply and is in an unknown state. If you created this request, please <a href="{{ login_url }}">log in</a> and set a new status.{% endblocktrans %}</div>
{% endif %}

{% if object.user == user and object.awaits_classification %}
  <div class="alert alert-info no-print">{% blocktrans with name=user.get_full_name %}<b>Hey {{ name }}</b>, please read the latest response and <a href="#set-status" data-tabgo="tab">set a new status for this request</a>!{% endblocktrans %}</div>
{% endif %}

{% if object.user == user and object.is_overdue and object.awaits_response %}
  <div class="alert no-print">
    {% blocktrans with name=user.get_full_name %}<b>Hey {{ name }}</b>, your request is <b>overdue</b>!<br/>
    Please act now:{% endblocktrans %}
    <ul>
      <li>
        {% blocktrans %}Have you received a reply by <b>postal mail</b>? &rarr; <a data-tabgo="tab" href="#add-postal-reply">Add it to the records below!</a>{% endblocktrans %}
      </li>
      <li>
        {% blocktrans %}Have you not gotten any reply? &rarr; <a data-tabgo="tab" href="#write-message">Write a reminder to the public body!</a>{% endblocktrans %}
      </li>
    </ul>
  </div>
{% endif %}

{% if object.user == user and object.has_been_refused and object.law.mediator %}
  <div class="alert alert-info no-print">
    {% blocktrans %}You request has been refused.{% endblocktrans %}
    <a href="#escalate" data-tabgo="tab">{% blocktrans %}Consider sending a letter to a mediator{% endblocktrans %}</a>
  </div>
{% endif %}

{% if not object.is_foi %}
  <div class="alert alert-info">
    {% blocktrans %}This request is not an FoI request. This site is only for requesting specific information from public bodies.{% endblocktrans %}
  </div>
{% endif %}

<div class="row">
  <div class="span9">
    <h2>{{ object.title }}</h2>
    {% if object.user == user %}
      <ul class="nav nav-tabs request-nav no-print">
        <li{% if active_tab == 'info' %} class="active"{% endif %}>
          <a href="#info" data-toggle="tab">
            {% trans "Request" %}
          </a>
        </li>
        {% if object.message_needs_status %}
        <li{% if active_tab == 'set-status' %} class="active"{% endif %}>
          <a href="#set-status" data-toggle="tab">
            {% trans "Set status" %}
          </a>
        </li>
        {% endif %}
        {% if object.status == "publicbody_needed" %}
          <li{% if active_tab == "choose-public-body" %} class="active"{% endif %}>
            <a href="#choose-public-body" data-toggle="tab">
              {% trans "Choose Public Body" %}
            </a>
          </li>
        {% endif %}
        {% if object.public_body %}
          <li{% if active_tab == 'add-postal-reply' %} class="active"{% endif %}>
            <a href="#add-postal-reply" data-toggle="tab">
              {% blocktrans %}Got Mail?{% endblocktrans %}
            </a>
          </li>
          <li{% if active_tab == "write-message" %} class="active"{% endif %}>
            <a href="#write-message" data-toggle="tab">
              {% blocktrans %}Send a message{% endblocktrans %}
            </a>
          </li>
        {% endif %}
        {% if object.law.mediator %}
          <li{% if active_tab == 'escalate' %} class="active"{% endif %}>
            <a href="#escalate" data-toggle="tab">
              {% trans "Denied?" %}
            </a>
          </li>
        {% endif %}
        {% if object.status_is_final or object.law.meta %}
          <li>
            <a href="#more" data-toggle="tab">
              {% blocktrans %}More...{% endblocktrans %}
            </a>
          </li>
        {% endif %}
      </ul>

      <div class="tab-content well request-well">

        {# Set status #}
        {% with status_message=object.message_needs_status %}
          {% if status_message %}
            <div id="set-status" class="tab-pane no-print{% if active_tab == 'set-status' %} active{% endif %}">
              <h4>{% blocktrans with url=status_message.get_absolute_url %}Please <a href="{{ url }}">read the reply</a> and choose a new status {% endblocktrans %}</h4>
              <form class="form-horizontal" method="post" action="{% url 'foirequest-set_status' slug=object.slug %}#set-status">
                {% csrf_token %}
                {% if status_form %}
                  {% include "foirequest/_set_status.html" %}
                {% else %}
                  {% with status_form=object.get_status_form %}
                    {% include "foirequest/_set_status.html" %}
                  {% endwith %}
                {% endif %}
                <button class="btn" type="submit">{% blocktrans %}Set status{% endblocktrans %}</button>
              </form>
            </div>
          {% endif %}
        {% endwith %}
        {# End Set status #}

        {% if object.status == "publicbody_needed" %}
          <div class="no-print tab-pane{% if active_tab == 'choose-public-body' %} active{% endif %}" id="choose-public-body">
            {% with suggestions_form=object.public_body_suggestions_form %}
              {% if suggestions_form %}
                <p>{% blocktrans %}As the author of this request, please choose a public body from one of the suggestions:{% endblocktrans %}</p>
                <form method="post" action="{% url 'foirequest-set_public_body' slug=object.slug %}">
                  {% csrf_token %}
                  {{ suggestions_form }}
                  <button class="btn" type="submit">{% blocktrans %}Send this request to the selected Public Body{% endblocktrans %}</button>
                </form>
              {% endif %}
            {% endwith %}
          </div>
        {% endif %}

        {# Escalate #}
        {% if object.law.mediator %}
          <div class="tab-pane no-print{% if active_tab == 'escalate' %} active{% endif %}" id="escalate">
            <form class="form-horizontal" method="post" action="{% url 'foirequest-escalation_message' slug=object.slug %}#escalate">
              {% csrf_token %}
              <p>{% blocktrans with entity=object.law.mediator.name %}You can file a complaint to the {{ entity }} if you think your request was not properly handled.{% endblocktrans %}</p>
              {% if escalation_form %}
                {% form escalation_form using "bootstrap/horizontal.html" %}
              {% else %}
                {% with escalation_form=object.get_escalation_message_form %}
                  {% form escalation_form using "bootstrap/horizontal.html" %}
                {% endwith %}
              {% endif %}
              {% if not object.public %}
                <span class="help-block">{% blocktrans %}Your request is currently not public, but will be made accessible to the mediator via the special link in the message.{% endblocktrans %}</span>
              {% endif %}
              <button class="btn" type="submit">{% blocktrans %}Send Message{% endblocktrans %}</button>
            </form>
          </div>
        {% endif %}
        {# End Escalate #}

        {# Postal Reply #}
        {% if object.public_body %}
          <div class="tab-pane no-print{% if active_tab == 'add-postal-reply' %} active{% endif %}" id="add-postal-reply">
            <form class="form-horizontal" method="post" action="{% url 'foirequest-add_postal_reply' slug=object.slug %}#add-postal-reply" enctype="multipart/form-data">{% csrf_token %}
                {% if postal_reply_form %}
                  {% form postal_reply_form using "bootstrap/horizontal.html" %}
                {% else %}
                  {% with postal_reply_form=object.get_postal_reply_form %}
                    {% form postal_reply_form using "bootstrap/horizontal.html" %}
                  {% endwith %}
                {% endif %}
              <button type="submit" class="btn">{% blocktrans %}Add Postal Reply{% endblocktrans %}</button>
              <span class="help-block">{% blocktrans %}You can attach more documents to this reply later.{% endblocktrans %}</span>
            </form>
          </div>
          {# End Postal Reply #}

          {# Reply #}
          <div class="tab-pane no-print{% if active_tab == 'write-message' %} active{% endif %}" id="write-message">
            <form class="form-horizontal" method="post" action="{% url 'foirequest-send_message' slug=object.slug %}#write-message">
              {% csrf_token %}
              {% if object.is_overdue and object.awaits_response %}
                <p>{% blocktrans %}Your request is <b>overdue</b>. You should send a reminder to the Public Body!{% endblocktrans %}</p>
              {% else %}
                <p>{% blocktrans %}You can send another message to this Public Body if you want to.{% endblocktrans %}</p>
              {% endif %}
              {% if send_message_form %}
                {% form send_message_form using "bootstrap/horizontal.html" %}
              {% else %}
                {% with send_message_form=object.get_send_message_form %}
                  {% form send_message_form using "bootstrap/horizontal.html" %}
                {% endwith %}
              {% endif %}
              <button class="btn" type="submit">{% blocktrans %}Send Message{% endblocktrans %}</button>
            </form>
          </div>
        {% endif %}
        {# End Reply, end if object.public_body #}

        {# If Meta Law #}
        {% if object.law.meta or object.status_is_final %}
          <div class="tab-pane no-print" id="more">
            {% if object.law.meta %}
              <h4>{% trans "Set Law" %}</h4>
              <form method="post" action="{% url 'foirequest-set_law' slug=object.slug %}">
                {% csrf_token %}
                <p>{% blocktrans %}This request was made under multiple information laws. If it is apparent from the reply under which law the request was answered, please choose this law below. If it is not obvious, leave it as it is.{% endblocktrans %}</p>
                {{ object.get_concrete_law_form.as_p }}
                <button type="submit" class="btn">{% blocktrans %}Set Concrete Law{% endblocktrans %}</button>
              </form>
            {% endif %}
            {# Write Resolution #}
            {% if object.status_is_final %}
              <h4>{% blocktrans %}Resolution Summary{% endblocktrans %}</h4>
              <form method="post" action="{% url 'foirequest-set_resolution' slug=object.slug %}">
                {% csrf_token %}
                <p>{% blocktrans %}Have you received the information you need? What have you learned from it?{% endblocktrans %}</p>
                <textarea rows="8" class="span6" name="resolution">{% if object.resolution %}{{ object.resolution }}{% endif %}</textarea><br/>
                <button type="submit" class="btn">{% blocktrans %}Save Summary{% endblocktrans %}</button>
              </form>
            {% endif %}
            {# End Write Resolution #}
          </div>
        {% endif %}

        {% if not object.public %}
          <div class="tab-pane no-print">
            <form action="{% url 'foirequest-make_public' slug=object.slug %}" method="post">
              {% csrf_token %}
              <p>
                {% blocktrans %}This request is <strong>not public</strong> at the moment. You can make this request public by clicking the button below.{% endblocktrans %}<br/>
                <button type="submit" class="btn">{% blocktrans %}Make this request public now{% endblocktrans %}</button>
              </p>
            </form>
          </div>
        {% endif %}
        <div class="tab-pane{% if active_tab == 'info' %} active{% endif %}" id="info">
      {% endif %}{# endif: object.user == user #}

        {# Public Body Needed #}
        {% if object.status == "publicbody_needed" %}
          <div class="well no-print">
            <p>{% blocktrans %}You can suggest a public body for this request.{% endblocktrans %}
            {% with suggestions=object.public_body_suggestions %}
              {% if suggestions %}
                <br/>{% blocktrans %}The following public bodies have already been suggested:{% endblocktrans %}
              {% endif %}
              </p>
              <ul>
              {% for suggestion in suggestions %}
                <li>
                  <strong>{{ suggestion.public_body.name }}</strong> - <a href="{{ suggestion.public_body.get_absolute_url }}" class="info-link">{% blocktrans %}Details{% endblocktrans %}</a>
                  {% if suggestion.reason %}
                    <br/>
                    {% blocktrans %}Reason given by the user:{% endblocktrans %} {{ suggestion.reason }}
                  {% endif %}
                </li>
              {% empty %}
                <li>{% blocktrans %}There are no suggestions yet{% endblocktrans %}</li>
              {% endfor %}
              </ul>
            {% endwith %}
            <form class="horizontal-form" method="post" action="{% url 'foirequest-suggest_public_body' slug=object.slug %}">
              {% csrf_token %}
              {% with form=object.make_public_body_suggestion_form %}
                {{ form.public_body }}
                {% formrow form.reason using "bootstrap/horizontal_row.html" %}
              {% endwith %}
              <button class="btn" type="submit">{% blocktrans %}Suggest this Public Body{% endblocktrans%}</button>
            </form>
          </div>
        {% endif %}
        {# End Public Body Needed #}

    <dl>
      <dt>{% blocktrans %}Request to:{% endblocktrans %}</dt>
      <dd>
        {% if object.public_body %}
          <a href="{{ object.public_body.get_absolute_url }}">{{ object.public_body.name }}</a>
        {% else %}
          {% blocktrans %}Not yet known{% endblocktrans %}
        {% endif %}
      </dd>
      {% if object.law %}
        {% if object.law.meta %}
          <dt>{% blocktrans %}Laws used:{% endblocktrans %}</dt>
          <dd>
            <ul>
              {% for law in object.law.combined.all %}
                <li>
                  <a href="{% url 'publicbody-foilaw-show' slug=law.slug %}" class="target-new">{{ law.name }}</a>
                </li>
              {% endfor %}
            </ul>
          </dd>
        {% else %}
          <dt>{% blocktrans %}Law used:{% endblocktrans %}</dt>
          <dd>
            <a href="{% url 'publicbody-foilaw-show' slug=object.law.slug %}" class="target-new">{{ object.law.name }}</a>
          </dd>
        {% endif %}
      {% else %}
        <dt>{% blocktrans %}Law used:{% endblocktrans %}</dt>
        <dd>{% blocktrans %}Not yet set{% endblocktrans %}</dd>
      {% endif %}
      <dt>{% blocktrans %}Status of this request:{% endblocktrans %}</dt>
      <dd>{{ object.readable_status }}</dd>
      {% if object.awaits_response %}
        <dt>{% blocktrans %}Due date:{% endblocktrans %}</dt>
        {% if object.is_overdue %}
          <dd class="red">
            {{ object.due_date|date:"DATE_FORMAT" }} - {% blocktrans with due=object.due_date|timesince %}{{ due }} ago{% endblocktrans %}
          </dd>
        {% else %}
          <dd>
            {{ object.due_date|date:"DATE_FORMAT" }} - {% blocktrans with due=object.due_date|timeuntil %}in {{ due }}{% endblocktrans %}
        {% endif %}
          <a class="no-print" href="{% url 'help-foi_officers' %}#frist">{% blocktrans %}How is this calculated?{% endblocktrans %}</a>
          </dd>
      {% endif %}
      {% if object.refusal_reason %}
        <dt>{% blocktrans %}Refusal Reason{% endblocktrans %}</dt>
        <dd>{{ object.refusal_reason }}</dd>
      {% endif %}
      {% if object.costs > 0 %}
        <dt>{% blocktrans %}Cost of information:{% endblocktrans %}</dt>
        <dd>{{ object.costs|floatformat:2 }} {{ froide.currency }}</dd>
        {% endif %}
      {% if object.description %}
        <dt>{% blocktrans %}Summary of Request{% endblocktrans %}</dt>
        <dd>{{ object.get_description|urlizetrunc:40|linebreaks }}</dd>
        {% endif %}
      {% if object.resolution %}
        <dt>{% blocktrans %}Summary of Resolution{% endblocktrans %}</dt>
        <dd>{{ object.resolution|urlizetrunc:40|linebreaks }}</dd>
      {% endif %}
    </dl>

    {# Public Body Needed #}
    {% if object.status == "publicbody_needed" %}
      <div class="alert alert-info">
        {% blocktrans %}This request was not sent yet, because it still needs a Public Body as a recipient.{% endblocktrans %}
      </div>
      {% if not object.public %}
        <div class="alert alert-info no-print">
          {% blocktrans %}This request is not public and will not receive suggestions for public bodies from users!{% endblocktrans %}
        </div>
      {% endif %}
    {% endif %}

    {# Unconfirmed Public Body #}
    {% if object.public_body and not object.public_body.confirmed %}
      <div class="alert alert-info">
        {% blocktrans %}The public body of this request has been created by the user and still needs to be confirmed.{% endblocktrans %}
      </div>
    {% endif %}
    {# End Unconfirmed Public Body #}
    {% if user == object.user %}
      </div>
    </div>
    {% endif %}
  </div>

  <div class="span3">
    <ul class="nav nav-list no-print">
      <li class="nav-header">{% trans "Followers" %}</li>
      {% with count=object.follow_count %}
        <li>
          <span class="badge{% if count %} badge-info{% endif %}">{% blocktrans count counter=count %}{{ counter }} follower{% plural %}{{ counter }} followers{% endblocktrans %}</span>
          <br/><br/>
        </li>
      {% endwith %}

      {% if user.is_authenticated and user != object.user %}
        <li>
          <form method="post" action="{% url 'foirequestfollower-follow' slug=object.slug %}" id="followrequest-form">
            {% csrf_token %}
            {% if followform %}
              {{ followform.as_p }}
              <button type="submit" class="btn">{% trans "Follow request" %}</button>
            {% else %}
              {% followrequest object user "followform" %}
              {{ followform.as_p }}
              {% if followform.following %}
                <button class="input-large btn btn-info hover-btn-warning" type="submit">
                  <span class="on-hover">
                    <i class="icon-white icon-remove"></i>
                    {% trans "Unfollow request" %}
                  </span>
                  <span class="on-display">
                    <i class="icon-white icon-star"></i>
                    {% trans "You follow this request" %}
                  </span>
                </button>
                <p class="muted">
                  <small>
                    {% blocktrans %}You get notified of changes.{% endblocktrans %}
                  </small>
                </p>
              {% else %}
                <button class="input-large btn hover-btn-success" type="submit">
                  <span class="on-hover">
                    <i class="icon-white icon-star"></i>
                    {% trans "Follow request" %}
                  </span>
                  <span class="on-display">
                    <i class="icon-star-empty"></i>
                    {% trans "Follow request?" %}
                  </span>
                </button>
                <p class="muted">
                  <small>
                    {% blocktrans %}Get notified by email of changes.{% endblocktrans %}
                  </small>
                </p>
              {% endif %}
            {% endif %}
          </form>
        </li>
      {% endif %}

      {% if object.visibility == 2 %}
        <li class="nav-header">{% trans "Share this request" %}</li>
        <li>
          <div class="socialshareprivacy"></div><br/>
        </li>
      {% endif %}

      <li class="nav-header">{% trans "Feeds" %}</li>
      <li>
        <a href="{% url 'foirequest-feed' slug=object.slug %}">
          <i class="rss-icon"></i>
          {% trans "RSS Feed" %}
        </a>
      </li>
      <li>
        <a href="{% url 'foirequest-feed_atom' slug=object.slug %}">
          <i class="atom-icon"></i>
          {% trans "Atom Feed" %}
        </a>
      </li>

      <li class="nav-header">{% trans "Short URL" %}</li>
      <li>
        <input type="text" readonly value="{{ object.get_absolute_domain_short_url }}"/>
      </li>

      {% with object.tags.all as tags %}
        {% if tags %}
          <li class="nav-header">{% trans "Tags" %}</li>
          <li>
            <ul class="tag-list">
              {% for tag in tags %}
                <li>
                  <a href="{% url 'foirequest-list' tag=tag.slug %}">{{ tag.name }}</a>
                </li>
              {% endfor %}
            </ul>
          </li>
        {% endif %}
      {% endwith %}

      {% if user.is_staff %}
        <li class="nav-header">{% trans "Staff Actions" %}</li>
        <li>
          <a href="{% url 'admin:foirequest_foirequest_change' object.id %}">{% trans "View on Admin site" %}</a>
        </li>
        <li>
          <form method="post" action="{% url 'foirequest-set_tags' slug=object.slug %}">
            {% csrf_token %}
            {% with object.get_set_tags_form as set_tags_form %}
              {{ set_tags_form.tags }}
            {% endwith %}
          </form>
        </li>
        {% if object.checked %}
          <li>{% trans "Marked as checked" %}</li>
        {% else %}
          <li>
            <form method="post" action="{% url 'foirequest-mark_checked' slug=object.slug %}">
              {% csrf_token %}
              <button class="btn" type="submit">{% trans "Mark as checked" %}</button>
            </form>
          </li>
        {% endif %}
        {% if not object.is_foi %}
          <li>{% trans "Marked as NOT FoI" %}</li>
        {% else %}
          <li>
            <form method="post" action="{% url 'foirequest-mark_not_foi' slug=object.slug %}">
              {% csrf_token %}
              <button class="btn" type="submit">{% trans "Mark as NOT FoI" %}</button>
            </form>
          </li>
        {% endif %}
      {% endif %}
    </ul>
  </div>

</div>

<hr/>

<div class="row" data-spy="scroll" data-target="#message-nav">

  <div class="span3 pull-right">
    {% if object.messages %}
      <ul id="message-nav" class="message-nav sticky nav nav-list">
      {% for message in object.messages %}
        {% ifchanged message.sender %}
          <li class="nav-header">
            {% if message.sender_public_body %}
              <span title="{{ message.sender_public_body.name }}">
                {{ message.sender_public_body.name|truncatechars:30 }}
              </span>
            {% else %}
              <span title="{{ message.sender }}">
                {{ message.sender|truncatechars:30 }}
              </span>
            {% endif %}
          </li>
        {% endifchanged %}
        <li>
          <a href="#{{ message.get_html_id }}">
            {{ message.timestamp|date:"SHORT_DATE_FORMAT" }}
          </a>
        </li>
      {% endfor %}
      </ul>
    {% endif %}
  </div>

  <div class="span9">
    <h4 id="messages">{% blocktrans %}Messages in this request{% endblocktrans %}</h4>

    {% for message in object.messages %}
      <div id="{{ message.get_html_id }}" class="message-container">
        <div class="message{% if not message.sender_user %} message-received{% endif %}{% if message.is_postal %} message-postal{% endif %}{% if message.is_escalation %} message-escalated{% endif %}">
          <table class="message-table">
            <tbody>
              <tr>
                <td class="key">{% blocktrans %}From{% endblocktrans %}</td>
                <td class="value-padding-right">
                  {% if object.user == user %}
                    {% if message.is_response %}
                      {{ message.real_sender }} – {{ message.sender_public_body.name }} (<a href="#change-pb-{{ message.id }}" class="toggle">{% trans "change" %}</a>)
                      <div id="change-pb-{{ message.id }}" style="display:none" class="no-print">
                        {% with message_pb_form=message.get_public_body_sender_form %}
                          <form method="post" action="{% url 'foirequest-set_message_sender' slug=object.slug message_id=message.id %}">
                            {% csrf_token %}
                            <label for="id_m{{ message.id }}-sender">{% blocktrans %}Set the Public Body that sent this message:{% endblocktrans %}</label>
                            {{ message_pb_form.sender }}
                            <button type="submit" class="btn">{% blocktrans %}Set Sending Public Body{% endblocktrans %}</button>
                          </form>
                        {% endwith %}
                      </div>
                    {% else %}
                      {{ message.real_sender }}
                    {% endif %}
                  {% else %}
                    {{ message.sender }}
                  {% endif %}
                </td>
              </tr>
              <tr>
                <td class="key">{% blocktrans %}Subject{% endblocktrans %}</td>
                <td class="value-padding-right"><strong>{{ message.get_subject }}</strong></td>
              </tr>
              <tr>
                <td class="key">{% blocktrans %}Date{% endblocktrans %}</td>
                {% if message.is_postal %}
                  <td>{{ message.timestamp|date:"DATE_FORMAT" }}</td>
                {% else %}
                  <td>{{ message.timestamp|date:"DATETIME_FORMAT" }}</td>
                {% endif %}
              </tr>
              {% if not message.is_response %}
                <tr>
                  <td class="key">{% blocktrans %}To{% endblocktrans %}</td>
                  <td>{{ message.get_recipient }}</td>
                </tr>
              {% endif %}
              {% if message.status %}
                <tr>
                  <td class="key">{% blocktrans %}Status{% endblocktrans %}</td>
                  <td>{{ message.readable_status }}</td>
                </tr>
              {% endif %}
              {% if user.is_staff %}
                <tr class="no-print">
                  <td class="key">{% blocktrans %}Admin{% endblocktrans %}</td>
                  <td>
                    <a href="{% url 'admin:foirequest_foimessage_change' message.id %}">{% trans "View message in admin" %}</a>
                  </td>
                </tr>
              {% endif %}
              {% if message.all_attachments %}
                <tr>
                  <td class="key">{% blocktrans %}Attachments{% endblocktrans %}</td>
                  <td>
                    <ul>
                      {% for attachment in message.all_attachments %}
                        {% if attachment.approved or user.is_staff or user == request.user %}
                          <li>
                            {% if not attachment.approved %}
                              <div class="alert">
                            {% endif %}
                            {% if attachment.approved %}
                              <a id="{{ attachment.get_html_id }}" href="{{ attachment.get_absolute_url }}">
                                {{ attachment.name }} ({{ attachment.size|filesizeformat }})
                              </a>
                              {% if attachment.can_preview %}
                                -
                                <a class="target-new" href="{{ attachment.get_preview_url }}">
                                  {% trans "Preview in Browser" %}
                                </a>
                              {% endif %}
                            {% else %}
                              {% if user == object.user or user.is_staff %}
                                <a id="{{ attachment.get_html_id }}" href="{{ attachment.get_absolute_url }}">
                                  {{ attachment.name }} ({{ attachment.size|filesizeformat }})
                                </a>
                                {% if attachment.can_preview %}
                                  -
                                  <a class="target-new" href="{{ attachment.get_preview_url }}">
                                    {% trans "Preview in Browser" %}
                                  </a>
                                {% endif %}
                                {% if attachment.can_approve or user.is_staff %}
                                  <form class="no-print" method="post" action="{% url 'foirequest-approve_attachment' slug=object.slug attachment=attachment.pk %}">
                                    {% csrf_token %}
                                    {% if object.user.get_profile.private %}
                                      <p>
                                        {% trans "Please check this attachment and if it doesn't contain personally identifying information and if you are not explicitly forbidden to publish it, click the button below." %}
                                      </p>
                                    {% else %}
                                      <p>
                                        {% blocktrans with name=object.user.get_full_name %}Please check this attachment and if it doesn't contain personally identifying information beyond the name ({{ name }}) and if publication is not explicitly forbidden, click the button below.{% endblocktrans %}
                                      </p>
                                    {% endif %}
                                    {% if not attachment.can_approve %}
                                      <p>
                                        <strong>{% blocktrans %}This attachment has been blocked from publishing.{% endblocktrans %}</strong>
                                        {% blocktrans %}As a moderator you are still able to publish it.{% endblocktrans %}
                                      </p>
                                    {% endif %}
                                    <button class="btn" type="submit">{% trans "Publish this attachment" %}</button>
                                    <p>{% trans "If it does contain personally identifying information, please inform moderators (info@fragdenstaat.de) and they will redact the document and then publish it for you." %}</p>

                                    {% if user.is_staff %}
                                      <p>
                                        <a href="{% url "foirequest-redact_attachment" slug=object.slug attachment_id=attachment.id %}">
                                        {% if attachment.is_redacted %}
                                          {% trans "Update this redacted version" %}
                                        {% endif %}
                                        {% if attachment.redacted %}
                                          {% trans "Update the redacted version of this attachment" %}
                                        {% endif %}
                                        {% if not attachment.redacted and not attachment.is_redacted %}
                                          {% trans "Redact this attachment" %}
                                        {% endif %}
                                        </a>
                                      </p>
                                    {% endif %}
                                  </form>
                                {% else %}
                                  <p>{% blocktrans %}This attachment has been blocked from publishing.{% endblocktrans %}</p>
                                {% endif %}
                              {% else %}
                                {% if not attachment.can_approve %}
                                  <span>{% trans "This attachment can't be published." %}</span>
                                {% else %}
                                  <span>{% trans "This attachment has not been published yet." %}</span>
                                {% endif %}
                              {% endif %}
                              {% if not attachment.approved %}
                                </div>
                              {% endif %}
                            {% endif %}
                          </li>
                        {% endif %}
                      {% endfor %}
                    </ul>
                  </td>
                </tr>
              {% endif %}
              {% if user == object.user and message.is_postal %}
                <tr class="no-print">
                  <td class="key">{% blocktrans %}Upload Attachments{% endblocktrans %}</td>
                  {% with form=message.get_postal_attachment_form %}
                    <td>
                      <form method="post" action="{% url 'foirequest-add_postal_reply_attachment' slug=object.slug message_id=message.pk %}" enctype="multipart/form-data">
                        {% csrf_token %}
                        {{ form.scan }}
                        <button type="submit" class="upload-button btn">{% blocktrans %}Upload Document{% endblocktrans %}</button>
                        <span class="help-block">{{ form.scan.help_text }}</span>
                      </form>
                    </td>
                  {% endwith %}
                </tr>
              {% endif %}
            </tbody>
          </table>
          {% if message.not_publishable %}
            <div class="alert no-print alert-info">
              <p>{% blocktrans %}This reply contains documents that every person can get individual access to. However, we are not allowed to publish these documents online.{% endblocktrans %}</p>
              {% if user.is_authenticated %}
                {% if object.user == user %}
                  <p>{% blocktrans %}You stated that you are not allowed to publish the received documents. If this was a mistake, please contact info@example.com.{% endblocktrans %}</p>
                {% else %}
                  {% if object.same_as.user == user %}
                    <p>{% blocktrans %}You made the original request.{% endblocktrans %}</p>
                  {% else %}
                    {% check_same_request object user "same_request" %}
                    {% if same_request %}
                      <a href="{{ same_request.get_absolute_url }}">{% blocktrans %}You made an identical request.{% endblocktrans %}</a>
                    {% else %}
                      <form method="post" class="no-print" action="{% url 'foirequest-make_same_request' slug=object.slug message_id=message.id %}">
                        {% csrf_token %}
                        <p>{% blocktrans %}You can make a request identical to this one in your name to gain individual access to the information that we are not allowed to publish here.{% endblocktrans %}</p>
                        <button type="submit" class="btn btn-primary">{% trans "Make identical request in your name" %}</button>
                      </form>
                    {% endif %}
                  {% endif %}
                {% endif %}
              {% else %}
                <form method="post" id="make-same-request" class="form-horizontal no-print" action="{% url 'foirequest-make_same_request' slug=object.slug message_id=message.id %}#make-same-request">
                  {% csrf_token %}
                  <p>{% blocktrans %}You can make a request identical to this one in your name to gain individual access to the information that we are not allowed to publish here.{% endblocktrans %}</p>
                  {% if not new_user_form %}
                    {% get_new_user_form "new_user_form" %}
                  {% endif %}
                  {% form new_user_form using "bootstrap/horizontal.html" %}
                  <button type="submit" class="btn btn-primary">{% trans "Make identical request in your name" %}</button>
                </form>
              {% endif %}
              <p>{% blocktrans count counter=object.identical_count %}So far one person also requested this document.{% plural %}So far <strong>{{ counter }} people</strong> requested this document.{% endblocktrans %}</p>
            </div>
          {% endif %}

          <hr/>

          <div id="{{ message.get_html_id }}-content" class="message-content">
            {% if forloop.counter0 == 0 %}
              <div>{% highlight_request message %}<div>
<a class="toggle no-print muted hideparent" href="#letter_end">{% trans "[... Show complete request text]" %}</a>
{% blocktrans %}Kind Regards,{% endblocktrans %}
{{ message.sender }}</div>
              </div>
            {% else %}
              <div>{{ message.get_content|urlize }}</div>
            {% endif %}
          </div>
        </div>
        {% if object.user == user %}
          {% if object.message_needs_status == message %}
          <div class="alert alert-info">
            <button type="button" class="close" data-dismiss="alert">×</button>
            <a data-tabgo="tab" href="#set-status">{% blocktrans %}Please set a new status for this request now{% endblocktrans %}</a>
          </div>
          {% endif %}
          <div class="alert alert-info">
            <a data-tabgo="tab" href="#write-message">{% blocktrans %}You can write a reply by clicking here{% endblocktrans %}</a>
          </div>
        {% endif %}

        {% if message.events %}
          <div class="events">
            <ol>
              {% for event in message.events %}
                <li class="event" id="{{ event.get_html_id }}">
                  <span class="no-print" title="{{ event.timestamp }}">{% blocktrans with time=event.timestamp|timesince %}{{ time }} ago{% endblocktrans %}</span><span class="print-only">{{ event.timestamp|date:"DATETIME_FORMAT" }}</span>: {{ event.as_html }}
                </li>
              {% endfor %}
            </ol>
          </div>
        {% endif %}

        <div class="comments-container no-print">
          {% get_comment_list for message as comment_list %}
          <div id="comments-{{ message.id }}" class="comments">
            {% include "comments/foirequest/list.html" %}
            <a class="toggle" href="#comment-form-{{ message.id }}">{% blocktrans %}Write a comment{% endblocktrans %}</a>
            <div class="comment-form" id="comment-form-{{ message.id }}">
              {% if user.is_authenticated %}
                {% with next=object.get_absolute_url %}
                  {% render_comment_form for message %}
                {% endwith %}
              {% else %}
                <a href="{% url 'account-login' %}" class="no-print">{% blocktrans %}Please login to write a comment.{% endblocktrans %}</a><br/>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
      {% if not forloop.last %}
        <div class="page-break"></div>
      {% endif %}
      {% empty %}
      <p>{% blocktrans %}No messages yet{% endblocktrans %}</p>
    {% endfor %}
  </div>
</div>

{% if object.same_as_count %}
  <div class="row">
    <div class="span8 no-print" id="identical">
      <h5>{% blocktrans count counter=object.same_as_count %}One identical request{% plural %}{{ counter }} identical requests{% endblocktrans %}</h5>
      <ul>
        {% for foirequest in object.same_as_set.all %}
          <li>
            {{ foirequest.first_message|date:"SHORT_DATE_FORMAT" }}: <a href="{{ foirequest.get_absolute_url }}">{{ foirequest.readable_status }}</a>
          </li>
        {% endfor %}
      </ul>
    </div>
  </div>
{% endif %}
{% if object.same_as %}
  <div class="row">
    <div class="span8 no-print" id="identical">
      <p>
        {% blocktrans %}This request is identical to:{% endblocktrans %}
        <a href="{{ object.same_as.get_absolute_url }}">{{ object.same_as.title }}</a>
      </p>
    </div>
  </div>
{% endif %}

{% endblock %}

{% block extra_footer %}
<script type="text/javascript" src="{{ STATIC_URL }}js/libs/jquery.socialshareprivacy.min.js"></script>
<script type="text/javascript">
  var STATIC_URL = "{{ STATIC_URL }}";
  $(function(){
    $("#public_body-chooser input[name='public_body']").live("change", function(e){
      Froide.app.publicBodyChosen($("#public_body-chooser input[name='public_body']:checked").val());
    });
    $("#id_status").change(function(){
      Froide.app.statusSet();
    });
    Froide.app.statusSet();
    loggedInCallback = function(data){
      $('.now-loggedin').hide();
      location.href = $("link[rel='self']").attr("href");
    };
    if($('.socialshareprivacy').length > 0){
      $('.socialshareprivacy').socialSharePrivacy({
        css_path: STATIC_URL + "js/libs/socialshareprivacy/socialshareprivacy.css",
        uri: "{{ SITE_URL }}{{ object.get_absolute_url }}",
        services: {
          facebook: {
            perma_option: 'off',
            dummy_img: STATIC_URL + "js/libs/socialshareprivacy/images/dummy_facebook.png"
          },
          twitter: {
            perma_option: 'off',
            dummy_img: STATIC_URL + "js/libs/socialshareprivacy/images/dummy_twitter.png"
          },
          gplus: {
            perma_option: 'off',
            dummy_img: STATIC_URL + "js/libs/socialshareprivacy/images/dummy_gplus.png"
          }
        }
      });
    }
  });
</script>
{% endblock %}
